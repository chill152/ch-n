<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>3D Hand Gesture Particles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; color: white; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; pointer-events: auto; }
        #video_container { position: absolute; bottom: 10px; right: 10px; width: 180px; height: 135px; border: 2px solid #444; border-radius: 8px; overflow: hidden; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { font-size: 12px; margin-bottom: 5px; opacity: 0.8; }
    </style>
</head>
<body>

<div id="ui">
    <h3 style="margin:0 0 10px 0">3D Particle Control</h3>
    <div class="label">MÀU SẮC</div>
    <input type="color" id="colorPicker" value="#00ffff">
    <div id="status" style="margin-top:10px; color:#0f0; font-size:13px">Đang tải AI...</div>
</div>

<div id="video_container">
    <video id="input_video"></video>
</div>

<script>
    // --- KHỞI TẠO THREE.JS ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    camera.position.z = 500;

    // Tạo nhóm hạt
    const particleCount = 2000;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const originalPositions = new Float32Array(particleCount * 3);

    for (let i = 0; i < particleCount; i++) {
        // Tạo hình cầu ngẫu nhiên
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos((Math.random() * 2) - 1);
        const r = 150;

        const x = r * Math.sin(phi) * Math.cos(theta);
        const y = r * Math.sin(phi) * Math.sin(theta);
        const z = r * Math.cos(phi);

        positions[i * 3] = x;
        positions[i * 3 + 1] = y;
        positions[i * 3 + 2] = z;

        originalPositions[i * 3] = x;
        originalPositions[i * 3 + 1] = y;
        originalPositions[i * 3 + 2] = z;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const material = new THREE.PointsMaterial({
        size: 3,
        color: 0x00ffff,
        transparent: true,
        blending: THREE.AdditiveBlending
    });

    const particleSystem = new THREE.Points(geometry, material);
    scene.add(particleSystem);

    // --- XỬ LÝ NHẬN DIỆN TAY (MEDIAPIPE) ---
    const videoElement = document.getElementById('input_video');
    const statusText = document.getElementById('status');
    let targetRotationX = 0;
    let targetRotationY = 0;
    let expansionMode = 0;

    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            statusText.innerText = `Đang điều khiển (${results.multiHandLandmarks.length} tay)`;
            
            // Lấy tọa độ tay đầu tiên để xoay (Xoay 360)
            const firstHand = results.multiHandLandmarks[0][9]; // Gốc ngón giữa
            targetRotationY = (firstHand.x - 0.5) * Math.PI * 2;
            targetRotationX = (firstHand.y - 0.5) * Math.PI * 2;

            // Nếu có 2 tay, tính khoảng cách để bung tỏa (Expansion)
            if (results.multiHandLandmarks.length >= 2) {
                const h1 = results.multiHandLandmarks[0][0];
                const h2 = results.multiHandLandmarks[1][0];
                const dist = Math.sqrt(Math.pow(h1.x - h2.x, 2) + Math.pow(h1.y - h2.y, 2));
                expansionMode = Math.max(0, (dist - 0.2) * 10);
            } else {
                expansionMode = 0; // Thu về hình cầu
            }
        } else {
            statusText.innerText = "Giơ tay để bắt đầu";
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    const cam = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640, height: 480
    });
    cam.start();

    // --- VÒNG LẶP ANIMATION ---
    function animate() {
        requestAnimationFrame(animate);

        // Làm mượt chuyển động xoay
        particleSystem.rotation.y += (targetRotationY - particleSystem.rotation.y) * 0.1;
        particleSystem.rotation.x += (targetRotationX - particleSystem.rotation.x) * 0.1;

        // Cập nhật vị trí hạt (Bung tỏa)
        const posAttr = geometry.attributes.position;
        for (let i = 0; i < particleCount; i++) {
            const ix = i * 3, iy = i * 3 + 1, iz = i * 3 + 2;
            
            // Tính toán vị trí mới dựa trên expansionMode
            const ratio = 1 + expansionMode;
            posAttr.array[ix] = originalPositions[ix] * ratio;
            posAttr.array[iy] = originalPositions[iy] * ratio;
            posAttr.array[iz] = originalPositions[iz] * ratio;
        }
        posAttr.needsUpdate = true;

        renderer.render(scene, camera);
    }

    document.getElementById('colorPicker').addEventListener('input', (e) => {
        material.color.set(e.target.value);
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
